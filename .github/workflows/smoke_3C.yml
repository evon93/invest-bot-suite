name: Smoke Test 3C

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  smoke-3c:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install test dependencies if needed
          pip install pytest pytest-cov

      - name: Run pytest
        run: |
          python -m pytest -q tests/

      - name: Run 3C Runner Smoke
        run: |
          python tools/run_live_integration_3C.py \
            --data data/ci_smoke.csv \
            --out report/out_ci_smoke_3C \
            --seed 42 \
            --max-bars 10 \
            --risk-version v0.6

      - name: List outputs
        run: |
          ls -R report/out_ci_smoke_3C

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smoke-3c-results
          path: |
            report/out_ci_smoke_3C/events.ndjson
            report/out_ci_smoke_3C/run_meta.json
            report/out_ci_smoke_3C/state.db
