commit 32ab87ddb8ec2ea9730fc6e48c80106847abb9bb
Author: evon93 <ivn_brm12@hotmail.com>
Date:   Wed Jan 14 20:32:41 2026 +0100

    3M.5: closeout handoff + bridge + registro + pytest post-merge

diff --git a/registro_de_estado_invest_bot.md b/registro_de_estado_invest_bot.md
index 36189ae..c663e1c 100644
--- a/registro_de_estado_invest_bot.md
+++ b/registro_de_estado_invest_bot.md
@@ -4,7 +4,29 @@ _Registro histórico, contexto para IAs colaboradoras y trazabilidad completa._
 
 ---
 
-## Estado Actual (2026-01-14) — Fase 3L: MarketDataAdapter Integration & Hardening
+## Estado Actual (2026-01-14) — Fase 3M: Adapter Mode End-to-End & Checkpoint/Resume
+
+- **Rama:** `main` (post merge 3M.2 + H0)
+- **Estado:** ✅ COMPLETADO
+- **Entregables:**
+  - **Adapter Mode E2E:** `run_adapter_mode()` con `ExchangeAdapter` (paper/stub).
+  - **Checkpoint/Resume:** Reanudación determinista desde disco (`checkpoint.json`, `state.db`) sin duplicar eventos.
+  - **Report Hygiene:** Normalización UTF-8 de artefactos antiguos en `report/`.
+  - **Tests:** Nuevos tests de integración `end-to-end` e `idempotencia`.
+- **Handoff:**
+  - `report/ORCH_HANDOFF_post3M_close_20260114.md`
+  - `report/bridge_3M_to_next_report.md`
+- **Verificación:**
+  - Pytest: 729 passed, 11 skipped
+  - Smoke tests: adapter-mode first_run + resume (idempotency verified)
+- **Commits:**
+  - AG-3M-1-1: `c957bc3` (Adapter Mode E2E)
+  - AG-3M-2-1: `5620a1d` (Checkpoint/Resume)
+  - AG-3M-0-1: `33c3382` (Report H0 cleanup)
+
+---
+
+## Estado Anterior (2026-01-14) — Fase 3L: MarketDataAdapter Integration & Hardening
 
 - **Rama:** `feature/AG-3L-4-1_closeout` (pendiente merge a main)
 - **HEAD:** `3de4827` — AG-3L-3-1: MockOHLCVClient edge-cases + strict validation
diff --git a/report/ORCH_HANDOFF_post3M_close_20260114.md b/report/ORCH_HANDOFF_post3M_close_20260114.md
new file mode 100644
index 0000000..2bd1352
--- /dev/null
+++ b/report/ORCH_HANDOFF_post3M_close_20260114.md
@@ -0,0 +1,58 @@
+# Handoff Report: Phase 3M Closeout
+
+**Date:** 2026-01-14
+**Phase:** 3M (Adapter Mode End-to-End & Checkpoint/Resume)
+**Status:** ✅ COMPLETE
+**Baseline:** `main` (post 3M.2 + H0)
+
+## 1. Executive Summary
+
+Phase 3M successfully extended the `adapter-mode` execution pipeline to support full end-to-end trading (Strategy → Risk → Execution → PositionStore) using `ExchangeAdapter` (Paper/Stub), and implemented a deterministic checkpoint/resume mechanism for crash recovery.
+
+Key Achievements:
+
+- **End-to-End Adapter Mode**: Unified the execution flow for `adapter` mode to match `bus` mode semantics without using the heavy `DataFrame` bridge.
+- **Checkpoint & Resume**: Added robust state persistence (`checkpoint.json`, `state.db`) allowing resuming interrupted runs without duplication (idempotency guarded).
+- **No-Lookahead Invariant**: Strictly enforced temporal constraints during both live execution and resume operations.
+- **Report Normalization**: Standardized report artifacts to UTF-8 to resolve cross-platform encoding issues.
+
+## 2. Technical Deliverables
+
+### A. Adapter Mode Extension (3M.1)
+
+- **Component**: `engine/loop_stepper.py`
+- **Feature**: Added `_step_with_adapter()` to orchestrate the pipeline directly from `MarketDataAdapter` events.
+- **Integration**: `tools/run_live_3E.py` now supports `--data-mode adapter` with `--exchange paper|stub`.
+- **Verification**: New tests `tests/test_adapter_mode_end_to_end_paper_3M1.py`.
+
+### B. Checkpoint & Resume (3M.2)
+
+- **Component**: `engine/loop_stepper.py` & `tools/run_live_3E.py`
+- **Feature**:
+  - `Checkpoint` state saving after each processed step.
+  - Resume logic skips warmup and already-processed events.
+  - Idempotency ensured via index tracking and skipped replays.
+- **Verification**: New tests `tests/test_adapter_mode_resume_idempotent_3M2.py`.
+
+### C. Artifact Normalization (3M.H0)
+
+- **Action**: Converted legacy UTF-16/Binary report artifacts to clean UTF-8.
+- **Scope**: `report/` directory artifacts from 3M.1 and 3M.2.
+
+## 3. Evidence & Verification
+
+- **Full Suite**: `729 passed, 11 skipped` (see `report/pytest_3M_postmerge.txt`).
+- **Smoke Tests**: Validated offline via `report/out_3M1_smoke/` and `report/out_3M2_smoke/` (first_run/resume_run).
+- **Return Packets**: Fully generated for 3M.1, 3M.2, and H0.
+
+## 4. Known Risks & Technical Debt
+
+- **Report Directory Bloat**: The `report/` directory contains many untracked legacy files (`.txt`, `.json` from previous phases). A cleanup policy is needed (Phase 3N/3O).
+- **Idempotency Keys**: `idempotency_keys.jsonl` may be empty if no trades occur (e.g., in smoke tests with low volatility). This is expected behavior.
+- **Exchange Adapter Deps**: `StubNetworkExchangeAdapter` implementation details are mocked; real network integration will require further validation in Phase 4.
+
+## 5. Next Steps (Recommended)
+
+- **Phase 3N**: Improve CLI usability and flag documentation (current flags are functional but complex).
+- **Phase 3O**: Comprehensive cleanup of `report/` and consolidation of documentation.
+- **Phase 4**: Migration to real exchange adapters (CCXT).
diff --git a/report/bridge_3M_to_next_report.md b/report/bridge_3M_to_next_report.md
new file mode 100644
index 0000000..baf382f
--- /dev/null
+++ b/report/bridge_3M_to_next_report.md
@@ -0,0 +1,48 @@
+# Bridge Report: Phase 3M to Next Phase
+
+**From:** Phase 3M (Adapter Mode E2E & Resilience)
+**To:** Next Phase (3N/3O/4A)
+**Date:** 2026-01-14
+
+## 1. State of the System
+
+The `Orchestrator` (`run_live_3E.py`) is now capable of running in two distinct robust modes:
+
+1. **Bus Mode**: Using `DataFrame` bridge (legacy/batch optimized).
+2. **Adapter Mode**: Direct event stream consumption (low latency optimized) with full Strategy/Risk/Exec pipeline and crash recovery.
+
+Both modes share the same `ExchangeAdapter` interfaces (Paper/Stub) and `risk_manager` sizing logic.
+
+## 2. What Remains to be Done (Gap Analysis)
+
+### Operational
+
+- **CLI Complexity**: `tools/run_live_3E.py` has many flags. A unified config file approach or simpler aliases would help reliability.
+- **Smoke Gating in CI**: Currently smoke tests are manual/local. Adding specific adapter-mode resume scenarios to CI would prevent regression.
+
+### Technical Debt
+
+- **Report Hygiene**: `report/` folder is cluttered.
+- **Test Coverage**: While `3M` added targeted tests, edge cases like "resume exactly at bar close" vs "resume mid-bar" (if sub-bar granularity added) need future attention.
+
+## 3. Implementation Suggestions for Next Phase
+
+### A. Report Cleanup (Phase 3O)
+
+- Archive old `report/*` files to `archive/` or delete.
+- Enforce gitignore policies strictly.
+
+### B. CI Integration
+
+- Add a job that runs `run_live_3E.py --data-mode adapter ...` then kills it, then resumes, and asserts final state.
+
+### C. Live deployment prep (Phase 4)
+
+- Validate `adapter-mode` with real CCXT generic adapter (read-only first).
+- Verify `checkpoint.json` behavior on real system crashes (OOM, SIGKILL).
+
+## 4. Critical Files to Watch
+
+- `engine/loop_stepper.py`: Core logic for both modes.
+- `tools/run_live_3E.py`: CLI entry point.
+- `engine/checkpoint.py`: Persistence logic.
diff --git a/report/pytest_3M_postmerge.txt b/report/pytest_3M_postmerge.txt
new file mode 100644
index 0000000..480c311
--- /dev/null
+++ b/report/pytest_3M_postmerge.txt
@@ -0,0 +1,39 @@
+﻿.........................................................s.............. [  9%]
+........................................................................ [ 19%]
+........................................................................ [ 29%]
+..........................................s............................. [ 38%]
+........................................................................ [ 48%]
+................................s....................................... [ 58%]
+......ssss.........sss.................................................. [ 68%]
+........................................................................ [ 77%]
+........................................................................ [ 87%]
+........................................................................ [ 97%]
+...................                                                      [100%]
+============================== warnings summary ===============================
+tests/test_multiseed_spec_2G2.py::TestMultiSeedSpec::test_run_determinism
+tests/test_multiseed_spec_2G2.py::TestMultiSeedSpec::test_run_determinism
+  C:\Program Files\Python313\Lib\site-packages\numpy\lib\_function_base_impl.py:3065: RuntimeWarning: invalid value encountered in divide
+    c /= stddev[:, None]
+
+tests/test_ohlcv_loader.py::test_load_csv_standard_aliases
+  C:\Users\ivn_b\Desktop\invest-bot-suite\tests\test_ohlcv_loader.py:23: DeprecationWarning: is_datetime64tz_dtype is deprecated and will be removed in a future version. Check `isinstance(dtype, pd.DatetimeTZDtype)` instead.
+    assert pd.api.types.is_datetime64tz_dtype(df["timestamp"])
+
+tests/test_ohlcv_loader.py::test_epoch_seconds_timestamp_parses_to_utc
+  C:\Users\ivn_b\Desktop\invest-bot-suite\tests\test_ohlcv_loader.py:108: DeprecationWarning: is_datetime64tz_dtype is deprecated and will be removed in a future version. Check `isinstance(dtype, pd.DatetimeTZDtype)` instead.
+    assert pd.api.types.is_datetime64tz_dtype(df["timestamp"])
+
+tests/test_ohlcv_loader.py::test_epoch_milliseconds_timestamp_parses_to_utc
+  C:\Users\ivn_b\Desktop\invest-bot-suite\tests\test_ohlcv_loader.py:122: DeprecationWarning: is_datetime64tz_dtype is deprecated and will be removed in a future version. Check `isinstance(dtype, pd.DatetimeTZDtype)` instead.
+    assert pd.api.types.is_datetime64tz_dtype(df["timestamp"])
+
+tests/test_ohlcv_loader.py::test_epoch_microseconds_timestamp_parses_to_utc
+  C:\Users\ivn_b\Desktop\invest-bot-suite\tests\test_ohlcv_loader.py:136: DeprecationWarning: is_datetime64tz_dtype is deprecated and will be removed in a future version. Check `isinstance(dtype, pd.DatetimeTZDtype)` instead.
+    assert pd.api.types.is_datetime64tz_dtype(df["timestamp"])
+
+tests/test_ohlcv_loader.py::test_timezone_offset_string_converts_to_utc
+  C:\Users\ivn_b\Desktop\invest-bot-suite\tests\test_ohlcv_loader.py:149: DeprecationWarning: is_datetime64tz_dtype is deprecated and will be removed in a future version. Check `isinstance(dtype, pd.DatetimeTZDtype)` instead.
+    assert pd.api.types.is_datetime64tz_dtype(df["timestamp"])
+
+-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
+729 passed, 11 skipped, 7 warnings in 38.35s
