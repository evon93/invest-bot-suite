# DS-3J-1-1 ‚Äî Audit compat default + no-lookahead (Strategy selector v0.8)

**Auditor:** DS (Design Safety)  
**Fecha:** 2026-01-12  
**Baseline:** PLAN_EXECUTOR_3J_StrategyAlphaValidation_v0_1  
**Scope:** PASO 3J.1 (Strategy selector) + early contract/lookahead risks  

---

## üîç Findings

| √Årea | Estado | Observaci√≥n |
|------|--------|-------------|
| **Compatibilidad con defaults (v0_7)** | ‚úÖ | El plan especifica que `--strategy` mantiene default `v0_7`. Esto preserva la compatibilidad con scripts y CI existentes. |
| **CLI/runtime_config integraci√≥n** | ‚ö†Ô∏è | No se especifica si `runtime_config` ya soporta estrategias. Si no existe un `StrategyRegistry`, AG debe crearlo sin romper `run_live_3E` actual. |
| **Contrato de entrada/salida** | ‚úÖ | Input: tick/bar + estado m√≠nimo (cash/positions). Output: lista de `OrderIntentV1` con `trace_id`. Coherente con contracts V1. |
| **No-lookahead (detecci√≥n temprana)** | ‚ö†Ô∏è | Riesgos t√≠picos: OHLCV slicing con offset incorrecto, rolling windows que usan `future=True`, timestamps de barra mal alineados. |
| **Dependencias impl√≠citas** | ‚úÖ | No se mencionan dependencias de wallclock, seed externa, o estado global mutable. El plan enfatiza determinismo con `seed=42`. |
| **Test coverage m√≠nimo** | ‚ö†Ô∏è | Plan sugiere tests de selector y default, pero no cubre edge cases de runtime_config heredado. |

---

## ‚ö†Ô∏è Riesgos Identificados

1. **Registry/factory inexistente:** Si no existe un mecanismo de registro de estrategias, AG podr√≠a introducir un cambio breaking en `run_live_3E` (ej: cambiar firma de funci√≥n).
2. **Lookahead por desplazamiento de ventanas:** En 3J.2, c√°lculos como SMA cross o zscore deben usar `shift(1)` o ventanas que terminen en `t-1`, no `t`.
3. **Timestamp de barra vs tiempo de decisi√≥n:** Si el runner pasa la barra completa (OHLCV) con timestamp `t`, la estrategia no debe usar `close[t]` para se√±al en `t` (es lookahead).
4. **Compatibilidad con m√©tricas existentes:** Si `OrderIntentV1` cambia (ej: nuevos campos), RiskManager podr√≠a rechazarlos.
5. **CLI parsing ambiguo:** Si `--strategy` se a√±ade con `argparse` pero `runtime_config` lo ignora, habr√≠a inconsistencia.

---

## ‚úÖ Recomendaciones

### Para 3J.1 (Selector)
- Verificar si ya existe `StrategyRegistry` o similar en `strategy_engine/`.
- Si no existe, implementar un factory simple con dict mapping `{name: class}`.
- Asegurar que `runtime_config.strategy` se propague a `run_live_3E` sin side effects.
- A√±adir validaci√≥n en CLI: si estrategia no existe, fallar con mensaje claro.

### Para 3J.2 (No-lookahead)
- Implementar un decorator o check en tests que valide que ninguna funci√≥n de se√±al accede a datos con √≠ndice > current_time.
- Usar `pandas.DataFrame.shift(1)` para c√°lculos de rolling.
- En c√°lculos de rolling, iniciar ventana despu√©s de `min_periods`.
- Documentar en c√≥digo: ‚Äú# NO LOOKAHEAD: datos hasta t-1 inclusive‚Äù.

### Tests Adicionales Sugeridos
- `test_strategy_default_fallback`: ejecutar sin `--strategy` y verificar que es v0_7.
- `test_strategy_invalid_name`: verificar que CLI rechaza estrategia no registrada.
- `test_runtime_config_overrides_cli`: verificar que config file puede sobreescribir CLI.
- `test_no_lookahead_fixture`: inyectar datos con NaN futuros y verificar que no afecta se√±ales pasadas.

---

## üìã Checklist para 3J.2 (No-lookahead)

- [ ] OHLCV data se corta con `.loc[:current_time]`.
- [ ] Rolling windows usan `min_periods` y `closed='left'` (o equivalente).
- [ ] C√°lculos de se√±al no usan `.shift(-1)` o `.diff()` sin ajuste.
- [ ] Timestamp de barra se trata como tiempo de cierre (se√±al v√°lida para pr√≥ximo tick).
- [ ] Warm-up: si datos insuficientes, retornar lista vac√≠a (no NaN/None en intents).
- [ ] Random seed (si se usa) se pasa expl√≠citamente y no se llama a `random()` global.

---

## üß™ Tests Sugeridos (extensi√≥n)

```python
# tests/test_strategy_v0_8_no_lookahead.py
import pandas as pd
import numpy as np

def test_no_lookahead_with_future_data():
    # Fixture: 100 barras
    data = pd.DataFrame(...)
    # Ejecutar estrategia hasta t=50
    intents_1 = strategy.run(data.iloc[:50])
    # Modificar datos futuros (t=51..100)
    data_modified = data.copy()
    data_modified.iloc[51:] *= 2
    # Volver a ejecutar hasta t=50
    intents_2 = strategy.run(data_modified.iloc[:50])
    # Deben ser id√©nticos
    assert intents_1 == intents_2
```

---

## üèÅ Veredicto

**APROBADO CON CONDICIONES**

El dise√±o de 3J.1 es s√≥lido y mantiene compatibilidad. Los riesgos de lookahead y registro son manejables con las recomendaciones dadas. Se debe:

1. **Revisar el diff de AG-3J-1-1** para verificar la implementaci√≥n del registry y CLI.
2. **A√±adir los tests de no-lookahead** en 3J.2 como parte de DoD.
3. **Documentar el contrato de estrategia** en un `STRATEGY_CONTRACT.md` para futuras versiones.

---

**Pr√≥xima acci√≥n:**  
Una vez disponible `report/AG-3J-1-1_diff.patch`, DS realizar√° una revisi√≥n r√°pida de c√≥digo (fase 2) para verificar implementaci√≥n contra este auditor.