From 11f080ad770d4f702f7a86e45cd8e2bf14008def Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Iv=C3=A1n=20B=2E?= <ivan@example.com>
Date: Fri, 16 Jan 2026 14:42:27 +0100
Subject: [PATCH] 3O.4: closeout handoff + bridge + registro

---
 registro_de_estado_invest_bot.md   | 27 ++++++++++++-
 report/bridge_3O_to_next_report.md | 65 ++++++++++++++++++++++++++++++
 report/pytest_3O_closeout.txt      |  2 +
 3 files changed, 93 insertions(+), 1 deletion(-)
 create mode 100644 report/bridge_3O_to_next_report.md
 create mode 100644 report/pytest_3O_closeout.txt

diff --git a/registro_de_estado_invest_bot.md b/registro_de_estado_invest_bot.md
index c663e1c..72b1b33 100644
--- a/registro_de_estado_invest_bot.md
+++ b/registro_de_estado_invest_bot.md
@@ -4,7 +4,32 @@ _Registro histórico, contexto para IAs colaboradoras y trazabilidad completa._
 
 ---
 
-## Estado Actual (2026-01-14) — Fase 3M: Adapter Mode End-to-End & Checkpoint/Resume
+## Estado Actual (2026-01-15) — Fase 3O: Graceful Shutdown & Report Hygiene
+
+- **Rama:** `main` (PR #33 merged)
+- **HEAD:** `0ba489ba`
+- **Estado:** ✅ COMPLETADO
+- **Entregables:**
+  - **Graceful Shutdown:** `run_live_3E.py` y `supervisor_live_3E_3H.py` manejan SIGINT/SIGTERM con exit 0.
+  - **SIGTERM Race Fix:** Checkpoints de stop durante setup para evitar -15 en CI.
+  - **Report Housekeeping:** `tools/cleanup_report.py` + política `.gitignore` para efímeros.
+  - **Report Restoration:** Histórico `report/` restaurado tras borrado accidental.
+- **Handoff:**
+  - `report/ORCH_HANDOFF_post3O_close_20260115.md`
+  - `report/bridge_3O_to_next_report.md`
+- **Verificación:**
+  - CI PR #33: 12/12 PASS
+  - Pytest: 750+ passed
+  - Shutdown tests: 3 passed
+- **Commits:**
+  - AG-3O-2-1: Graceful shutdown (run_live)
+  - AG-3O-2-2: Supervisor + H0.1
+  - AG-3O-2-3: Report history restore
+  - AG-3O-2-4: SIGTERM race fix
+
+---
+
+## Estado Anterior (2026-01-14) — Fase 3M: Adapter Mode End-to-End & Checkpoint/Resume
 
 - **Rama:** `main` (post merge 3M.2 + H0)
 - **Estado:** ✅ COMPLETADO
diff --git a/report/bridge_3O_to_next_report.md b/report/bridge_3O_to_next_report.md
new file mode 100644
index 0000000..684b0b8
--- /dev/null
+++ b/report/bridge_3O_to_next_report.md
@@ -0,0 +1,65 @@
+# Bridge Report: Phase 3O → Next
+
+**Date:** 2026-01-15
+**Source Phase:** 3O (Graceful Shutdown & Report Hygiene)
+**Target Phase:** H1 / 4.x (Policy Refinement / Live Integration)
+
+## 1. Current State
+
+Phase 3O is complete. The system now supports:
+
+- **Graceful Shutdown**: SIGINT/SIGTERM → clean exit (0), checkpoint saved.
+- **Supervisor Resilience**: Child process restart with deterministic backoff; signals forwarded.
+- **Report Hygiene**: Cleanup script and `.gitignore` policy for ephemeral artifacts.
+
+**Branch**: `main` (post PR #33)
+**Verification**: 750+ tests passed; CI 12/12 green.
+
+## 2. Technical Debt
+
+| Item | Description | Priority |
+|------|-------------|----------|
+| Exit Code Semantics | Non-signal failures (e.g., config error) may exit 0 if handler is set. Should distinguish controlled shutdown vs. failure. | Medium |
+| Artifact Bloat | `report/` contains many historical artifacts (patches, runs). Consider compression or CI artifact upload. | Low |
+| Windows SIGTERM | Supervisor SIGTERM test skips on Windows (hard kill semantics). | Low |
+
+## 3. Recommended Next Steps (H1 / Phase 4)
+
+### H1.1: Artifact Storage Policy
+
+- **Goal**: Define a policy for heavy artifacts (patches, run outputs).
+- **Options**:
+  - Compress older artifacts (`.tar.gz` or `.zip`).
+  - Upload to CI artifacts instead of tracking in git.
+  - Generate digest summaries instead of full logs.
+
+### H1.2: Exit Code Refinement
+
+- **Goal**: Ensure `run_live_3E.py` exits non-zero for non-signal failures.
+- **Test**: Add `test_failure_must_be_nonzero` that causes a config error and asserts `exit_code != 0`.
+- **Implementation**: Wrap main logic in try/except; only exit 0 if `stop_controller.is_stop_requested`.
+
+### H1.3: Adapter-Mode SIGTERM (Optional)
+
+- **Goal**: Verify that adapter-mode also exits cleanly on SIGTERM.
+- **Checklist**:
+  - [ ] `run_adapter_mode` tested with SIGTERM.
+  - [ ] Checkpoint saved mid-stream.
+  - [ ] Resume produces same trades.
+
+### Phase 4: Live Integration
+
+- **Goal**: Connect to real exchange (CCXT) with network gating.
+- **Prerequisite**: Ensure graceful shutdown works with network I/O (timeouts, retries).
+
+## 4. Handoff Artifacts
+
+- `report/ORCH_HANDOFF_post3O_close_20260115.md`
+- `report/bridge_3O_to_next_report.md` (this file)
+- `report/AG-3O-4-1_return.md` (closeout return packet)
+
+## 5. Verification Command
+
+```bash
+pytest -q tests/test_graceful_shutdown_signal_3O2.py tests/test_graceful_shutdown_supervisor_3O2.py
+```
diff --git a/report/pytest_3O_closeout.txt b/report/pytest_3O_closeout.txt
new file mode 100644
index 0000000..07365c9
--- /dev/null
+++ b/report/pytest_3O_closeout.txt
@@ -0,0 +1,2 @@
+...                                                                      [100%]
+3 passed in 24.89s
-- 
2.43.0

