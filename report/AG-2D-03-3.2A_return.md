# AG-2D-03-3.2A Return Packet

**Fecha:** 2025-12-27  
**Objetivo:** Corregir ingestión de best_params_2C.json en runner 2D.

---

## Bug Corregido

**Antes (bug):** Gate por `"params" in best_params` pero aplicaba `params_dotted`.  
**Después:** `extract_params_dotted()` maneja ambos casos correctamente.

---

## Cambios Realizados

### tools/run_robustness_2D.py

```python
# Nuevos helpers añadidos:

def flatten_nested_params(params: dict) -> dict:
    """Flatten nested params to dotted format."""
    # {"kelly": {"cap_factor": 0.7}} -> {"kelly.cap_factor": 0.7}

def extract_params_dotted(best_params: dict) -> dict:
    """
    Priority:
    1. params_dotted (non-empty) -> use it
    2. params (nested) -> flatten to dotted
    3. else -> {}
    """

# Lógica corregida (líneas 314-324):
params_dotted = extract_params_dotted(best_params)
candidate_params_count = len(params_dotted)
if params_dotted:
    candidate_rules = apply_flat_params(candidate_rules, params_dotted)
else:
    print("WARNING: No candidate params found...")
```

### run_meta.json

Añadido campo `candidate_params_applied_count` para trazabilidad.

---

## Tests Añadidos

**Nuevo:** `tests/test_run_robustness_2D_best_params_ingest.py` (11 tests)

| Test | Descripción |
|------|-------------|
| `test_flatten_nested_params_*` | 4 tests para flatten |
| `test_extract_params_dotted_*` | 7 tests para extract |

---

## pytest Results

```
114 passed in 2.00s
```

(103 anteriores + 11 nuevos)

---

## git log -1 --oneline

```
2801f47 fix(runner): extract_params_dotted handles params_dotted and nested params
```

---

## DoD Checklist

- [x] Bug eliminado: candidate params se aplican con params_dotted aunque falte params
- [x] Pytest global pasa (114 tests)
- [x] Artefactos en repo
- [x] Working tree limpio (excepto artefactos de retorno)
